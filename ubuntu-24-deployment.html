<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. MoneyBags v1.x – Ubuntu 24.04 LTS Server Deployment Guide</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h2 {
            color: #2c3e50;
            margin-top: 25px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        h3 {
            color: #3498db;
            margin-top: 20px;
        }
        code {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            padding: 2px 4px;
            font-size: 0.9em;
        }
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 10px;
            overflow-x: auto;
            line-height: 1.4;
        }
        pre code {
            border: none;
            padding: 0;
            background-color: transparent;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .note {
            background-color: #e7f5fe;
            border-left: 4px solid #3498db;
            padding: 10px 15px;
            margin: 15px 0;
        }
        .warning {
            background-color: #fff5e6;
            border-left: 4px solid #e67e22;
            padding: 10px 15px;
            margin: 15px 0;
        }
        .architecture {
            font-family: monospace;
            white-space: pre;
            line-height: 1.2;
            background-color: #f8f8f8;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .section {
            margin-bottom: 30px;
        }
        .command {
            background-color: #2c3e50;
            color: #fff;
            padding: 10px 15px;
            border-radius: 3px;
            overflow-x: auto;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
        }
        .last-updated {
            color: #7f8c8d;
            font-style: italic;
            font-size: 0.9em;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <h1>Mr. MoneyBags v1.x – Ubuntu 24.04 LTS Server Deployment Guide</h1>
    <p class="last-updated">Last updated: August 2025</p>

    <div class="section">
        <h2 id="overview">1. Overview & Prerequisites</h2>
        <p>
            Mr. MoneyBags (MMB) is a Node.js + PostgreSQL web application served behind Nginx.<br>
            These instructions assume:
        </p>
        <ul>
            <li>Ubuntu 24.04 LTS minimal/server install</li>
            <li>DNS A/AAAA record for the site (e.g. <code>accounting.example.org</code>)</li>
            <li>A <strong>sudo-enabled</strong> user (e.g. your login user)</li>
            <li>Outbound internet access for apt / git / certbot</li>
        </ul>

        <h3>Quick facts</h3>
        <table>
            <tr>
                <th>Component</th>
                <th>Purpose</th>
                <th>Runs as</th>
            </tr>
            <tr>
                <td>Node 20.x</td>
                <td>API backend (port 3000 internal)</td>
                <td><code>mrmb</code> system user</td>
            </tr>
            <tr>
                <td>Nginx</td>
                <td>HTTPS termination, static file hosting, proxy <code>/api/</code> to Node</td>
                <td><code>www-data</code></td>
            </tr>
            <tr>
                <td>PostgreSQL</td>
                <td>Application database (can be local or external)</td>
                <td><code>postgres</code></td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h3 id="db-modes">6.4 Database Setup Modes (Installer)</h3>
        <p>The one-shot installer (<code>deployment/ubuntu24/install.sh</code>) supports optional database setup via <code>--db=MODE</code>:</p>
        <ul>
            <li><code>skip</code> (default): No DB operations</li>
            <li><code>create</code>: Create role &amp; database only (<code>database/setup-database.sql</code>)</li>
            <li><code>schema</code>: Role/DB + schema only (no sample data) – empty DB recommended for AccuFund imports</li>
            <li><code>full</code>: Role/DB + schema + built-in sample data (<code>database/db-init.sql</code>)</li>
            <li><code>macdump</code>: Schema + Mac test dataset (<code>database/sample-data-mac-export.sql</code>)</li>
            <li><code>principle</code>: Schema + The Principle Foundation dataset (<code>database/load-principle-foundation-data.js</code>)</li>
        </ul>

        <p>Examples:</p>
<pre class="command"># Empty schema only (prepare for AccuFund import later)
sudo ./deployment/ubuntu24/install.sh --db=schema

# Full schema + built-in sample data
sudo ./deployment/ubuntu24/install.sh --db=full

# Schema + Mac test dataset
sudo ./deployment/ubuntu24/install.sh --db=macdump

# Schema + Principle Foundation dataset
sudo ./deployment/ubuntu24/install.sh --db=principle</pre>

        <p class="note">
            Notes:<br>
            • The installer will install/start local PostgreSQL if required for <code>create</code>, <code>schema</code>, or <code>full</code> modes.<br>
            • If <code>/opt/mr-moneybags/.env</code> exists, it will read <code>PGHOST</code>, <code>PGPORT</code>, <code>PGDATABASE</code>, <code>PGUSER</code>, <code>PGPASSWORD</code> to target a remote DB.<br>
            • You may combine <code>--db</code> with other flags such as <code>--domain</code>, <code>--repo</code>, <code>--branch</code>, <code>--app-dir</code>, and <code>--user</code>.
        </p>
    </div>

    <div class="section">
        <h2 id="architecture">2. Reference Architecture</h2>
        <div class="architecture">
┌─────────┐   HTTPS 443              ┌────────────────────┐
│ Client  │ ───────────────►  Nginx  │  Static html / js  │
└─────────┘                          └────────────────────┘
                          │
                          │ proxy /api/*
                          ▼
                    Node.js (systemd)  –  server-modular.js  (port 3000)
                          │
                          ▼
                     PostgreSQL
        </div>
        <ul>
            <li><strong>Nginx</strong> serves all static assets from <code>$APP_DIR</code> and proxies <code>/api/</code> to Node.</li>
            <li><strong>Node</strong> runs as an unprivileged user under systemd with secure cookie + trust-proxy.</li>
            <li><strong>PostgreSQL</strong> may live on the same host or another server (set <code>DATABASE_URL</code>).</li>
        </ul>
    </div>

    <div class="section">
        <h2 id="variables">3. Variable Cheat-Sheet</h2>
        <table>
            <tr>
                <th>Variable</th>
                <th>Example value</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>DOMAIN</code></td>
                <td><code>accounting.example.org</code></td>
                <td>Fully-qualified domain served by Nginx / TLS</td>
            </tr>
            <tr>
                <td><code>APP_DIR</code></td>
                <td><code>/opt/mr-moneybags</code></td>
                <td>Directory where the repo is cloned</td>
            </tr>
            <tr>
                <td><code>RUN_USER</code></td>
                <td><code>mrmb</code></td>
                <td>Unix user that runs Node</td>
            </tr>
            <tr>
                <td><code>SERVICE_NAME</code></td>
                <td><code>mr-moneybags</code></td>
                <td>systemd unit name</td>
            </tr>
        </table>
        <p>You can override these in the one-shot installer (<code>deployment/ubuntu24/install.sh</code>).</p>
    </div>

    <div class="section">
        <h2 id="deployment">4. Step-by-Step Deployment</h2>

        <h3 id="update">4.1 Update System</h3>
        <pre class="command">sudo apt update && sudo apt upgrade -y</pre>

        <h3 id="packages">4.2 Install Node 20.x LTS, Git, Nginx, UFW</h3>
        <pre class="command">curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash -
sudo apt install -y nodejs git nginx ufw</pre>

        <h3 id="user">4.3 Create Service User & Application Directory</h3>
        <pre class="command">sudo useradd -m -r -s /bin/bash mrmb
sudo mkdir -p /opt/mr-moneybags
sudo chown mrmb:mrmb /opt/mr-moneybags</pre>

        <h3 id="source">4.4 Obtain Source Code</h3>
        <pre class="command">sudo -u mrmb git clone --branch main https://github.com/OWNER/REPO.git /opt/mr-moneybags</pre>
        <p class="note">(Substitute <strong>OWNER/REPO</strong> and <strong>branch</strong> as required.)</p>

        <h3 id="env">4.5 Environment Configuration</h3>
        <pre class="command">cd /opt/mr-moneybags
sudo -u mrmb cp .env.example .env
sudo -u mrmb nano .env            # fill SESSION_SECRET, DATABASE_URL, etc.</pre>
        <p>Key variables:</p>
        <ul>
            <li><code>SESSION_SECRET</code> – long random string</li>
            <li><code>DATABASE_URL</code> – <code>postgres://user:pass@host:5432/db</code></li>
            <li><code>CORS_ORIGINS</code> – leave blank for same-origin</li>
        </ul>

        <h3 id="npm">4.6 Install Node Dependencies</h3>
        <pre class="command">cd /opt/mr-moneybags
sudo -u mrmb npm install --omit=dev
# rebuild native bcrypt if needed
sudo -u mrmb npm rebuild bcrypt --build-from-source</pre>

        <h3 id="systemd">4.7 Install & Enable systemd Unit</h3>
        <pre class="command">sudo cp deployment/ubuntu24/mr-moneybags.service /etc/systemd/system/mr-moneybags.service
sudo systemctl daemon-reload
sudo systemctl enable --now mr-moneybags</pre>
        <p class="note">If you changed <code>APP_DIR</code> or <code>RUN_USER</code>, edit the unit file accordingly.</p>

        <h3 id="nginx">4.8 Configure Nginx Site</h3>
        <pre class="command">sudo cp deployment/ubuntu24/nginx/mr-moneybags.conf /etc/nginx/sites-available/mr-moneybags.conf
sudo sed -i "s/accounting.example.org/ACCOUNTING.DOMAIN.TLD/g" /etc/nginx/sites-available/mr-moneybags.conf
sudo ln -sf /etc/nginx/sites-available/mr-moneybags.conf /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx</pre>

        <h3 id="tls">4.9 Obtain TLS Certificate (Let's Encrypt)</h3>
        <pre class="command">sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d accounting.example.org</pre>
        <p>Certificates are auto-renewed via systemd timers.</p>

        <h3 id="firewall">4.10 Firewall Rules</h3>
        <pre class="command">sudo ufw allow OpenSSH
sudo ufw allow 'Nginx Full'
sudo ufw --force enable</pre>

        <h3 id="verify">4.11 Verify Deployment</h3>
        <pre class="command"># Service status
sudo systemctl status mr-moneybags

# Logs (Ctrl-C to quit)
sudo journalctl -u mr-moneybags -f

# Health check
curl -k https://accounting.example.org/api/health</pre>
        <p>Expected JSON:</p>
        <pre><code>{
  "status": "OK",
  "message": "Server running",
  "version": "9.0.0"
}</code></pre>
    </div>

    <div class="section">
        <h2 id="maintenance">5. Maintenance</h2>
        <table>
            <tr>
                <th>Task</th>
                <th>Command</th>
            </tr>
            <tr>
                <td>Pull latest code</td>
                <td><code>sudo -u mrmb git -C /opt/mr-moneybags pull</code></td>
            </tr>
            <tr>
                <td>Reinstall deps</td>
                <td><code>sudo -u mrmb npm install --omit=dev</code></td>
            </tr>
            <tr>
                <td>Restart service</td>
                <td><code>sudo systemctl restart mr-moneybags</code></td>
            </tr>
            <tr>
                <td>Follow logs</td>
                <td><code>sudo journalctl -u mr-moneybags -f</code></td>
            </tr>
        </table>

        <h3>Rolling back</h3>
        <pre class="command">sudo -u mrmb git -C /opt/mr-moneybags checkout &lt;previous-commit&gt;
sudo systemctl restart mr-moneybags</pre>
        <p>(Optionally tag stable releases so you can <code>git checkout v1.0.3</code>.)</p>
    </div>

    <div class="section">
        <h2 id="appendix">6. Appendix</h2>

        <h3 id="one-shot">6.1 One-Shot Installer</h3>
        <p>Instead of manual steps you can run:</p>
        <pre class="command">sudo bash deployment/ubuntu24/install.sh</pre>
        <p>Edit the variables at the top of the script (<code>DOMAIN</code>, <code>GIT_URL</code>, etc.) before running.<br>
        The script performs every step above: packages, user, clone, install, systemd, Nginx, UFW.</p>

        <h3 id="postgres">6.2 Local PostgreSQL Quick-Setup</h3>
        <pre class="command">sudo apt install -y postgresql
sudo -u postgres psql <<'SQL'
CREATE USER mrmb_user WITH PASSWORD 'STRONG_PASSWORD';
CREATE DATABASE mrmb_db OWNER mrmb_user;
GRANT ALL PRIVILEGES ON DATABASE mrmb_db TO mrmb_user;
\q
SQL</pre>
        <p>Set in <code>.env</code>:</p>
        <pre><code>DATABASE_URL=postgresql://mrmb_user:STRONG_PASSWORD@localhost:5432/mrmb_db</code></pre>
        <p>Restart:</p>
        <pre class="command">sudo systemctl restart mr-moneybags</pre>

        <h3 id="locations">6.3 File Locations Summary</h3>
        <table>
            <tr>
                <th>Path</th>
                <th>Purpose</th>
            </tr>
            <tr>
                <td><code>/opt/mr-moneybags</code></td>
                <td>Application code & static files</td>
            </tr>
            <tr>
                <td><code>/opt/mr-moneybags/.env</code></td>
                <td>Environment variables</td>
            </tr>
            <tr>
                <td><code>/etc/systemd/system/mr-moneybags.service</code></td>
                <td>systemd unit</td>
            </tr>
            <tr>
                <td><code>/etc/nginx/sites-available/mr-moneybags.conf</code></td>
                <td>Nginx site</td>
            </tr>
            <tr>
                <td><code>/var/www/letsencrypt</code></td>
                <td>ACME HTTP-01 challenges</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <p>Happy accounting! 🚀</p>
    </div>
</body>
</html>
